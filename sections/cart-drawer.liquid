{%- assign restricted_tag = 'restricted' -%}
{%- assign cart_has_restricted = false -%}
{%- if cart != empty -%}
  {%- for item in cart.items -%}
    {%- if item.product.tags contains restricted_tag -%}
      {%- assign cart_has_restricted = true -%}
      {%- break -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}

{%- capture cart_drawer_markup -%}
  {%- render 'cart-drawer' -%}
{%- endcapture -%}

{%- capture helper_markup -%}
  {%- if cart != empty and section.settings.helper_text != blank -%}
    <div class="cart-drawer__helper rte">
      {{ section.settings.helper_text }}
    </div>
  {%- endif -%}
  {%- if cart_has_restricted -%}
    <div class="verify-cart-note" data-verify-root>
      Restricted items require verification.
      <span class="verify-allowance" hidden>Remaining: <span data-verify-remaining></span>/<span data-verify-limit></span></span>
      <button class="link" type="button" data-verify-start>Verify now</button>
    </div>
    <script>
(()=>{const r=document.currentScript.previousElementSibling;if(!r)return;window.__verify?.getState?.().then((s)=>{if(s?.remaining!=null&&s?.limit!=null){const a=r.querySelector('.verify-allowance');a.hidden=false;a.querySelector('[data-verify-remaining]').textContent=s.remaining;a.querySelector('[data-verify-limit]').textContent=s.limit;}});window.__verify?.wire?.(document.currentScript.parentNode);})();
    </script>
  {%- endif -%}
{%- endcapture -%}

{%- capture default_heading -%}
<h2 class="drawer__heading">{{ 'sections.cart.title' | t }}</h2>
{%- endcapture -%}
{%- capture new_heading -%}
<h2 class="cart-drawer__title">Your Bag</h2>
{%- endcapture -%}

{%- assign modified_markup = cart_drawer_markup | replace: default_heading, new_heading -%}

{%- assign cart_items_token = 'id="CartDrawer-CartItems" class="drawer__contents js-contents">' -%}
{%- assign cart_items_with_helper = cart_items_token | append: helper_markup -%}
{%- assign modified_markup = modified_markup | replace_first: cart_items_token, cart_items_with_helper -%}

{{- modified_markup -}}

{% schema %}
{
  "name": "Cart drawer",
  "settings": [
    {
      "type": "richtext",
      "id": "helper_text",
      "label": "Helper text"
    }
  ]
}
{% endschema %}
